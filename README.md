# Terraform Compliance

---

2022.011. ì´ì¥ì¬    ğŸ“§ cine0831@gmail.com     ğŸ“‚ [https://github.com/jangjaelee](https://github.com/jangjaelee)    ğŸ“’ [http://www.awx.kr](http://www.awx.kr)

---

---

![Terraform-Compliance.png](https://raw.githubusercontent.com/jangjaelee/tutorial-terraform-compliance/main/Terraform-Compliance.png)

## What is Terraform Compliance?

Terraform-complianceëŠ” terraformì— ì˜í•´ ì •ì˜ëœ ì¸í”„ë¼ì˜ ê·œì • ì¤€ìˆ˜ë¥¼ ê²€ì¦í•˜ëŠ” í”„ë ˆì„ì›Œí¬ì´ë©°, ì´ëŠ” ì¸í”„ë¼ë¥¼ ê²€ì¦í•˜ê¸° ìœ„í•´ í•¨ê»˜ ì‘ë™í•˜ëŠ” ë¶€ì •ì ì¸ í…ŒìŠ¤íŠ¸ ë° BDDë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.Â ì´ ê²Œì‹œë¬¼ì€ ì´ í”„ë ˆì„ì›Œí¬ë¥¼ êµ¬í˜„í•˜ê³  IaCë¥¼ ë°°í¬í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” DevOps íŒŒì´í”„ë¼ì¸ì— ì¶”ê°€í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤

- Terraform IaaS(Infrastructure-as-code)ë¥¼ ìœ„í•œ ê²½ëŸ‰, ë³´ì•ˆ ë° ê·œì • ì¤€ìˆ˜ì— ì¤‘ì ì„ ë‘” í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.
- ì½”ë“œë¡œì„œì˜ ì¸í”„ë¼ì— ëŒ€í•œ ë¶€ì •ì ì¸ í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ì„ í™œì„±í™”í•©ë‹ˆë‹¤.
- êµ¬í˜„ëœ ì½”ë“œê°€ ë³´ì•ˆ ìš”êµ¬ ì‚¬í•­ì„ ì¶©ì¡±í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
- í‘œì¤€ ê·œì •ì„ ì‚¬ìš©ì ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## Requirements

- Python 3.x
- Terraform 0.12+

---

## **How does this work?**

Terraform-complianceëŠ” AWS S3 Bucketì—ì„œ í™œì„±í™”ëœ ì•”í˜¸í™”, íƒœê·¸ê°€ ì˜ ì§€ì •ëœ ë¦¬ì†ŒìŠ¤ ë“±ê³¼ ê°™ì´ ì¸í”„ë¼ì— ë°˜ë“œì‹œ ìˆì–´ì•¼ í•˜ëŠ” ê¸°ëŠ¥ì„ ì •ì˜í•˜ëŠ” ì •ì±…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì •ì±…ì€ Terraformì´ ìƒì„±í•˜ëŠ” ê³„íšì— ëŒ€í•´ ì‹¤í–‰ë˜ê³ Â **í–‰ë™ ì£¼ë„ ê°œë°œ(BDD)**Â ì›ì¹™ì„ ì‚¬ìš©í•˜ì—¬ ì •ì˜í•©ë‹ˆë‹¤.

ë˜í•œ, í´ë¼ìš°ë“œì˜ ìƒì„¸í•œ Billing reportë¥¼ ë³´ê¸° ìœ„í•´ì„œëŠ” ê° í´ë¼ìš°ë“œ ì œê³µìì—ì„œ ìš”êµ¬í•˜ëŠ” ë¹„ìš© í• ë‹¹ íƒœê·¸ê°€ í•„ìš”í•œë° ì´ë•Œ BDDì›ì¹™ì„ ì‚¬ìš©í•˜ì—¬ ëˆ„ë½ë˜ëŠ” íƒœê·¸ê°€ ì—†ê²Œ ê·œì •ì„ ì¤€ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì •ì±…ì„ ì •ì˜í•˜ê¸° ìœ„í•´ ì–¸ì–´(language)ë¡œ ì˜ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

Terraformìœ¼ë¡œ ì‘ì—…í•˜ê¸°ìœ„í•´ íŒŒì¼ í™•ì¥ìë¡œ feature ì‚¬ìš©í•˜ê³  í‰ê°€í•˜ë ¤ëŠ” ì‹œë‚˜ë¦¬ì˜¤ê°€ í¬í•¨ëœ BDD ì›ì¹™ì„ ì‚¬ìš©í•˜ì—¬ ì •ì±…ì´ ì •ì˜ëœ íŒŒì¼ì„ ë§Œë“¤ì–´ ì‚¬ìš©í•©ë‹ˆë‹¤.

íŒŒì¼ì˜ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- **Feature** : ê²€ì¦í•  ì‚¬í•­ì— ëŒ€í•œ ìš”ì•½
- **Senario / Senario Outline** : ì‹¤í–‰í•  í…ŒìŠ¤íŠ¸ë¥¼ ì •ì˜í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ ì…ë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” ì•„ë˜ì˜ BDD ì§€ì‹œë¬¸ì´ í¬í•¨ë©ë‹ˆë‹¤.
    - **Given** : í™•ì¸í•˜ë ¤ëŠ” ë¦¬ì†ŒìŠ¤ ë˜ëŠ” ë°ì´í„°ì˜ ëª©ë¡ì´ ë  ìˆ˜ ìˆëŠ” contextë¥¼ ì •ì˜í•˜ëŠ”ë° ì‚¬ìš©ë˜ë©° ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì •ì˜í•˜ëŠ” ì²« ë²ˆì§¸ ë‹¨ê³„ì…ë‹ˆë‹¤.
    - **When** : ì˜ˆë¥¼ ë“¤ì–´, ì •ì˜ëœ contextê°€ ëª¨ë“  S3 Bucketì„ í‰ê°€í•œë‹¤ê³  ë§í•˜ë©´ ìœ„ì—ì„œ ì •ì˜í•œ contextë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ WHENì„ ì‚¬ìš©í•˜ì—¬ tagë¡œ í•„í„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¡°ê±´ì´ í†µê³¼í•˜ì§€ ëª»í•˜ë©´ ì‹¤íŒ¨ ëŒ€ì‹  ë‹¤ìŒ ì¤„ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.
    - **Then** : WHENê³¼ ìœ ì‚¬í•œ ê¸°ëŠ¥ì„ ê°€ì§€ê³  ìˆì§€ë§Œ ì¡°ê±´ì´ í†µê³¼í•˜ì§€ ì•Šìœ¼ë©´ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì‹¤íŒ¨í•©ë‹ˆë‹¤.
    - **And** : ì‹œë‚˜ë¦¬ì˜¤ì— ì¶”ê°€ ì¡°ê±´ì„ ì •ì˜í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©° ì´ëŠ” ì„ íƒì  ëª…ë ¹ë¬¸ì…ë‹ˆë‹¤.
- **Steps** : í…ŒìŠ¤íŠ¸ì˜ ì„±ê³µ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ë° í•„ìš”í•œ ì‘ì—…ì„ ì‹¤ì œë¡œ ì‹¤í–‰í•˜ëŠ” ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.

ì •ì±…íŒŒì¼ ì˜ˆì‹œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```
Feature: Test tagging compliance

Scenario: Ensure all resources have tags
    Given I have resource that supports tags defined
    Then it must contain tags
    And its value must not be null

Scenario Outline: Ensure that specific tags are defined
    Given I have resource that supports tags defined
    When it has tags
    Then it must contain <tags>
    And its value must match the "<value>" regex

    Examples:
      | tags        | value              |
      | Name        | .+                 |
      | Environment | ^(prod\|uat\|dev)$ |
```

ê° BDD directive(ì§€ì‹œë¬¸)ì—ëŠ” ë” ë§ì€ ê¸°ëŠ¥ì´ ìˆìœ¼ë©°, terraform-complianceì˜ [BDD Reference](https://terraform-compliance.com/pages/bdd-references/)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

---

## Installation

íŒŒì´ì¬ 3.x ì´ìƒì´ í•„ìš”í•˜ë©°, PyPi íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

```bash
$ pip install terraform-compliance

$ terraform-compliance -h
terraform-compliance v1.3.34 initiated

usage: terraform-compliance [-h] [--terraform [terraform_file]] --features feature directory --planfile plan_file [--quit-early] [--no-failure] [--silent]
                            [--identity [ssh private key]] [--debug] [--version]

BDD Test Framework for Hashicorp terraform

options:
  -h, --help            show this help message and exit
  --terraform [terraform_file], -t [terraform_file]
                        The absolute path to the terraform executable.
  --features feature directory, -f feature directory
                        Directory (or git repository with "git:" prefix) consists of BDD features
  --planfile plan_file, -p plan_file
                        Plan output file generated by Terraform
  --quit-early, -q      Stops executing any more steps in a scenario on first failure.
  --no-failure, -n      Skip all the tests that is failed, but giving proper failure message
  --silent, -S          Do not output any scenarios, just write results or failures
  --identity [ssh private key], -i [ssh private key]
                        SSH Private key that will be use on git authentication.
  --debug, -d           Turns on debugging mode
  --version, -v         show program's version number and exit
```

Docker container imageë„ ì œê³µë˜ê³  ìˆì–´ ì•„ë˜ì˜ ëª…ë ¹ìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ docker pull eerkunt/terraform-compliance
```

---

## Using terraform compliance

ì•„ë˜ í…Œë¼í¼ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ AWS S3 Bucketì„ ìƒì„±í•˜ê³  íƒœê·¸ì´ë¦„ì„ ì„¤ì •í•©ë‹ˆë‹¤.

```yaml
provider "aws" {
  region              = var.region
  allowed_account_ids = var.account_id
  profile             = "default"
}

variable "region" {
  description = "AWS Region"
  type        = string
  default     = "ap-northeast-2"
}

variable "account_id" {
  description = "List of Allowed AWS account IDs"
  type        = list(string)
  default     = ["1234567890"]
}

variable "bucket" {
  description = "S3 bucket for terraform-state-backend"
  type        = string
  default     = "tf101-state-backend"
}

variable "s3_acl" {
  description = "ACL of S3 Bucket"
  type        = string
  default     = "private"
}

resource "aws_s3_bucket" "terraform_state_backend" {
  bucket = var.bucket

  lifecycle {
    prevent_destroy = false
  }

  tags = {
    Name = var.bucket
  }
}

resource "aws_s3_bucket_acl" "terraform_state_backend_acl" {
  bucket = aws_s3_bucket.terraform_state_backend.id
  acl    = var.s3_acl
}

resource "aws_s3_bucket_versioning" "terraform_state_backend_versioning" {
  bucket = aws_s3_bucket.terraform_state_backend.id
  versioning_configuration {
    status = "Enabled"
  }
}

resource "aws_s3_bucket_server_side_encryption_configuration" "terraform_state_backend_encryption" {
  bucket = aws_s3_bucket.terraform_state_backend.id

  rule {
    apply_server_side_encryption_by_default {
      #kms_master_key_id = aws_kms_key.mykey.arn
      #sse_algorithm     = "aws:kms"
      sse_algorithm = "AES256"
    }
  }
}

output "s3_bucket_name" {
  value = aws_s3_bucket.terraform_state_backend.bucket
}
```

### Step 1. terraform init

```bash
$ terraform fmt
$ terraform init
$ terraform validate
```

### Step 2. terraform plan

```bash
$ terraform plan -out=tfc.out
$ terraform show -json plan.out > plan.out.json
$ cat plan.out.json | jq
```

### Step 3. terraform-compliance

```bash
$ terraform-compliance -f compliance/ -p plan.json
terraform-compliance v1.3.34 initiated

ğŸš© Features     : /mnt/c/Users/ì´ì¥ì¬/Desktop/terraform/terraform-backend/compliance/
ğŸš© Plan File    : /mnt/c/Users/ì´ì¥ì¬/Desktop/terraform/terraform-backend/plan.json

ğŸš© Running tests. ğŸ‰

Feature: Check tags on the S3 resource  # /mnt/c/Users/ì´ì¥ì¬/Desktop/terraform/terraform-backend/compliance/s3.feature

    Scenario: Ensure all resources have tags
        Given I have resource that supports tags defined
        Then it must contain tags
        And its value must not be null

    Scenario Outline: Ensure that specific tags are defined
        Given I have aws_s3_bucket that supports tags defined
        When it has tags
        Then it must contain <tags>
        And its value must not be null

    Examples:
        | tags |
        ğŸ’¡ SKIPPING: Can not find aws_s3_bucket that supports tags defined in target terraform plan.
        | Name |

Feature: This is base for check basic of s3  # /mnt/c/Users/ì´ì¥ì¬/Desktop/terraform/terraform-backend/compliance/s3attr.feature

    Scenario Outline: S3 resources must be configured
        Given I have AWS S3 Bucket defined
        Then it must contain <attributes>

    Examples:
        | attributes |
        | tags       |

Feature: Check if s3 bucket has encrypted  # /mnt/c/Users/ì´ì¥ì¬/Desktop/terraform/terraform-backend/compliance/s3encrypt.feature

    Scenario: Ensure all S3 buckets are encrypted
        Given I have aws_s3_bucket_server_side_encryption_configuration defined
        When it has rule
        Then it must contain sse_algorithm
        And its value must contain AES256

Feature: Check if s3 bucket has private  # /mnt/c/Users/ì´ì¥ì¬/Desktop/terraform/terraform-backend/compliance/s3private.feature

    Scenario: Ensure all S3 buckets are private
        Given I have aws_s3_bucket_acl defined
        When it has acl
        Then its value must contain private

Feature: Test tagging compliance  # /mnt/c/Users/ì´ì¥ì¬/Desktop/terraform/terraform-backend/compliance/tagging.feature

    Scenario: Ensure all resources have tags
        Given I have resource that supports tags defined
        Then it must contain tags
        And its value must not be null

    Scenario Outline: Ensure that specific tags are defined
        Given I have resource that supports tags defined
        When it has tags
        Then it must contain <tags>
        And its value must match the "<value>" regex

    Examples:
        | tags        | value            |
        | Name        | .+               |
                Failure: aws_dynamodb_table.terraform_state_locks (aws_dynamodb_table) does not have Environment property.
                Failure: aws_s3_bucket.terraform_state_backend (aws_s3_bucket) does not have Environment property.
        | Environment | ^(prod|uat|dev)$ |
          Failure:

5 features (3 passed, 1 failed, 1 skipped)
8 scenarios (6 passed, 1 failed, 1 skipped)
27 steps (21 passed, 1 failed, 2 skipped)
Run 1668277974 finished within a moment
 (TF:default)(âˆ |rancher-desktop:default)
```

## Step 4. terraform apply

```bash
$ terraform apply
```

---

## Official Website

- Website
    - [https://terraform-compliance.com/](https://terraform-compliance.com/)
- GitHub
    - [https://github.com/terraform-compliance/cli](https://github.com/terraform-compliance/cli)
- PyPI
    - [https://pypi.org/project/terraform-compliance/](https://pypi.org/project/terraform-compliance/)

---

## Reference

- **[Implement compliance testing with Terraform and Azure](https://learn.microsoft.com/en-us/azure/developer/terraform/best-practices-compliance-testing)**
- ****[Announcing policy guardrails for Terraform on Google Cloud CLI preview](https://cloud.google.com/blog/products/compliance/google-cloud-cli-terraform-validation-preview?hl=en)****
- ****[Enforce Policy with Sentinel](https://developer.hashicorp.com/terraform/tutorials/policy)****
- [**TFLint**](https://github.com/terraform-linters/tflint)
- [**Terraform Security Checks - aqua tfsec**](https://aquasecurity.github.io/tfsec/)
- ****[How to test Terraform compliance using the Open Policy Agent (OPA)](https://youtu.be/fgiMk9EbNXU)****
- **Terraform Test Framework [[Web]](https://tf2project.io/) [[GitHub]](https://github.com/tf2project/tf2project)**
- [**radish-BDD - python BDD tool**](http://radish-bdd.io/)
- **[Gherkin Reference](https://cucumber.io/docs/gherkin/reference/)**
- [**https://playbook.hackney.gov.uk/API-Playbook/terraform_compliance**](https://playbook.hackney.gov.uk/API-Playbook/terraform_compliance)

---

**END**
